# app/agent.py
import os
import re
import time
from typing import Optional, List

from gigachat import GigaChat
from gigachat.models import Chat, Messages, MessagesRole

from app.storage import load_user_data, save_user_data

# ------------------------- –ö–æ–Ω—Ñ–∏–≥ -------------------------

GIGACHAT_MODEL: str = os.getenv("GIGACHAT_MODEL", "GigaChat-2-Max").strip()
GIGACHAT_TEMPERATURE: float = float(os.getenv("GIGACHAT_TEMPERATURE", "0.2"))
GIGACHAT_MAX_TOKENS: int = int(os.getenv("GIGACHAT_MAX_TOKENS", "2200"))
GIGACHAT_TIMEOUT: int = int(os.getenv("GIGACHAT_TIMEOUT", "60"))
GIGACHAT_RETRIES: int = int(os.getenv("GIGACHAT_RETRIES", "3"))

# ------------------------- –£—Ç–∏–ª–∏—Ç—ã –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∏ -------------------------

_RPE_PATTERNS = [
    r"\(?\s*RPE\s*=?\s*\d+(?:\s*-\s*\d+)?\s*\)?",
    r"\(?\s*RIR\s*=?\s*\d+(?:\s*-\s*\d+)?\s*\)?",
    r"\b–¥–æ\s+–æ—Ç–∫–∞–∑–∞\b",
    r"\b–ø–æ—á—Ç–∏\s+–¥–æ\s+–æ—Ç–∫–∞–∑–∞\b",
]

def _strip_rpe(text: str) -> str:
    """–£–±–∏—Ä–∞–µ–º RPE/RIR/¬´–¥–æ –æ—Ç–∫–∞–∑–∞¬ª, –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –º–∞—Ä–∫–µ—Ä—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã."""
    out = text
    for p in _RPE_PATTERNS:
        out = re.sub(p, "", out, flags=re.IGNORECASE)
    # 3x12 -> 3√ó12
    out = re.sub(r"(\d)\s*[xX\*]\s*(\d)", r"\1√ó\2", out)
    # –ü—É–ª–∏ –≤ –µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å
    out = re.sub(r"^\s*[‚Ä¢\-]\s*", "- ", out, flags=re.MULTILINE)
    # –ü–æ–¥—á–∏—Å—Ç–∏–º –ø—É—Å—Ç—ã–µ —Å–∫–æ–±–∫–∏ –∏ –¥–≤–æ–π–Ω—ã–µ –∑–∞–ø—è—Ç—ã–µ
    out = re.sub(r"\(\s*\)", "", out)
    out = re.sub(r",\s*,", ", ", out)
    # –õ–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã —É –ø–µ—Ä–µ–Ω–æ—Å–æ–≤
    out = re.sub(r"[ \t]+\n", "\n", out)
    out = re.sub(r"\n[ \t]+", "\n", out)
    out = re.sub(r"\n{3,}", "\n\n", out)
    return out.strip()

def _strip_html_like(text: str) -> str:
    """–°–∫–æ–±–æ—á–Ω—ã–µ HTML-—Ç–µ–≥–∏ -> –ø–µ—Ä–µ–Ω–æ—Å—ã / –Ω–∏—á–µ–≥–æ."""
    out = re.sub(r"\s*<br\s*/?>\s*", "\n", text, flags=re.IGNORECASE)
    out = re.sub(r"</?p\s*/?>", "\n", out, flags=re.IGNORECASE)
    return out

def _drop_hash_headings(text: str) -> str:
    """
    –¢–µ–ª–µ–≥—Ä–∞–º –∏–Ω–æ–≥–¥–∞ –ø—É—Ç–∞–µ—Ç—Å—è —Å # –∏ ## –≤ Markdown.
    –ü–µ—Ä–µ–≤–µ–¥—ë–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤–∏–¥–∞ '# ‚Ä¶' / '## ‚Ä¶' –≤ **–ø–æ–ª—É–∂–∏—Ä–Ω—ã–π**.
    """
    lines = text.splitlines()
    fixed: List[str] = []
    for ln in lines:
        if re.match(r"^\s*#{1,6}\s+", ln):
            title = re.sub(r"^\s*#{1,6}\s+", "", ln).strip()
            if title:
                fixed.append(f"**{title}**")
            else:
                fixed.append("")
        else:
            fixed.append(ln)
    return "\n".join(fixed)

def _sanitize(text: str) -> str:
    out = _strip_html_like(text)
    out = _strip_rpe(out)
    out = _drop_hash_headings(out)
    return out.strip()

def _physical_context(d: dict) -> str:
    """–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç –∞–Ω–∫–µ—Ç—ã –¥–ª—è –ø–æ–¥–º–µ—à–∏–≤–∞–Ω–∏—è –≤ –∑–∞–ø—Ä–æ—Å—ã."""
    phys = (d.get("physical_data") or {})
    def g(k, default="–Ω–µ —É–∫–∞–∑–∞–Ω–æ"):
        v = phys.get(k)
        return str(v).strip() if (v is not None and str(v).strip()) else default

    return (
        "–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n"
        f"- –¶–µ–ª—å: {g('target')}\n"
        f"- –ü–æ–ª: {g('gender')}\n"
        f"- –í–æ–∑—Ä–∞—Å—Ç: {g('age')}\n"
        f"- –†–æ—Å—Ç (—Å–º): {g('height')}\n"
        f"- –¢–µ–∫—É—â–∏–π –≤–µ—Å (–∫–≥): {g('weight')}\n"
        f"- –ñ–µ–ª–∞–µ–º—ã–π –≤–µ—Å (–∫–≥): {g('goal')}\n"
        f"- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è/–ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: {g('restrictions','–Ω–µ—Ç')}\n"
        f"- –ß–∞—Å—Ç–æ—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (—Ä–∞–∑/–Ω–µ–¥): {g('schedule')}\n"
        f"- –£—Ä–æ–≤–µ–Ω—å: {g('level')}"
    )

# ------------------------- –ü—Ä–æ–º—Ç—ã -------------------------

PLAN_SYSTEM_PROMPT = (
    "–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä –ø–æ —Å–∏–ª–æ–≤—ã–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º –∏ –±–æ–¥–∏–±–∏–ª–¥–∏–Ω–≥—É (–æ–ø—ã—Ç –±–æ–ª–µ–µ 8 –ª–µ—Ç). "
    "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ, –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å–∏–ª–æ–≤—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è –∑–∞–ª–∞, "
    "—É—á–∏—Ç—ã–≤–∞—è —Ü–µ–ª–∏, –ø–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç, –≤–µ—Å, —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏, —á–∞—Å—Ç–æ—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"

    "–û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞:\n"
    "‚Ä¢ –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç **Markdown**.\n"
    "‚Ä¢ –ù–µ –¥–æ–±–∞–≤–ª—è–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π, –ª–∏—à–Ω–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ç–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤—ã–π –ø–ª–∞–Ω.\n"
    "‚Ä¢ –ü–∏—à–∏ –≥—Ä–∞–º–æ—Ç–Ω–æ, –ø–æ–Ω—è—Ç–Ω–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ, –∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä —Ñ–∏—Ç–Ω–µ—Å-–∫–ª—É–±–∞.\n"
    "‚Ä¢ –°—Ç—Ä–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—É **–±–µ–∑ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n"
    "‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π RPE/RIR –∏ —Å–ª–æ–≤–∞ ¬´–¥–æ –æ—Ç–∫–∞–∑–∞¬ª.\n"
    "‚Ä¢ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–∞–≤–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å—Ç–∞—Ä—Ç–æ–≤–æ–º—É –≤–µ—Å—É –æ—Ç—è–≥–æ—â–µ–Ω–∏–π, –∏—Å—Ö–æ–¥—è –∏–∑ –ø–æ–ª–∞, –≤–µ—Å–∞, –≤–æ–∑—Ä–∞—Å—Ç–∞, —É—Ä–æ–≤–Ω—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏, —Ü–µ–ª–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n"
    "‚Ä¢ –î–µ–ª–∞–π –ø—Ä–æ–≥—Ä–∞–º–º—É —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–π –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–π, –∏–∑–±–µ–≥–∞—è –º–æ–Ω–æ—Ç–æ–Ω–Ω—ã—Ö –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –¥–≤–∏–∂–µ–Ω–∏–π.\n"
    "‚Ä¢ –ù–µ –≤–∫–ª—é—á–∞–π —Ç—Ä–∞–≤–º–æ–æ–ø–∞—Å–Ω—ã–µ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–ª–∏–º–ø–∏–π—Å–∫–∏–µ –ø–æ–¥—ä—ë–º—ã –±–µ–∑ –æ–ø—ã—Ç–∞).\n"
    "‚Ä¢ –ü–æ–¥–±–∏—Ä–∞–π –∞–¥–µ–∫–≤–∞—Ç–Ω—ã–π –æ–±—ä—ë–º —Ä–∞–±–æ—Ç—ã: –Ω–µ —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ, –Ω–æ –∏ –Ω–µ —á—Ä–µ–∑–º–µ—Ä–Ω–æ, —á—Ç–æ–±—ã —Ö–≤–∞—Ç–∞–ª–æ —Ä–µ—Å—É—Ä—Å–∞ –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å.\n\n"

    "–§–æ—Ä–º–∞—Ç –ø–ª–∞–Ω–∞:\n"
    "‚Ä¢ –ö–∞–∂–¥—ã–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –¥–µ–Ω—å –Ω–∞—á–∏–Ω–∞–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ –æ—Ç–¥–µ–ª—è–π –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π.\n"
    "‚Ä¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–Ω—è: **–î–µ–Ω—å N ‚Äî —á–∞—Å—Ç—å —Ç–µ–ª–∞/—Ç–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä: **–î–µ–Ω—å 1 ‚Äî –ì—Ä—É–¥—å –∏ —Ç—Ä–∏—Ü–µ–ø—Å**).\n"
    "‚Ä¢ –í –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è —É–∫–∞–∂–∏ —Ä–∞–∑–º–∏–Ω–∫—É (5‚Äì7 –º–∏–Ω—É—Ç) —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ (–∫–∞—Ä–¥–∏–æ, —Å—É—Å—Ç–∞–≤–Ω–∞—è —Ä–∞–∑–º–∏–Ω–∫–∞).\n"
    "‚Ä¢ –í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –¥–æ–±–∞–≤—å –∑–∞–º–∏–Ω–∫—É/—Ä–∞—Å—Ç—è–∂–∫—É (3‚Äì5 –º–∏–Ω—É—Ç).\n"
    "‚Ä¢ –ö–∞–∂–¥–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –æ—Ñ–æ—Ä–º–ª—è–π –≤ –≤–∏–¥–µ: ¬´- –ù–∞–∑–≤–∞–Ω–∏–µ ‚Äî 3√ó12, –æ—Ç–¥—ã—Ö 90 —Å–µ–∫., —É—Å–∏–ª–∏–µ: —É–º–µ—Ä–µ–Ω–Ω–æ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –≤–µ—Å: ~40 –∫–≥¬ª.\n"
    "  - –ï—Å–ª–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º –≤–µ—Å–æ–º ‚Äî —É–∫–∞–∂–∏ —ç—Ç–æ —è–≤–Ω–æ.\n"
    "  - –ï—Å–ª–∏ –≤–µ—Å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π ‚Äî —É—Ç–æ—á–Ω–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´~40 –∫–≥ –ø—Ä–∏ 8‚Äì10 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è—Ö¬ª).\n"
    "‚Ä¢ –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è —É–∫–∞–∑—ã–≤–∞–π –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Ö–æ–¥–æ–≤ –∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π, –∞ —Ç–∞–∫–∂–µ –≤—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞ "
    "–¥–ª—è —Ç—è–∂—ë–ª—ã—Ö –±–∞–∑–æ–≤—ã—Ö –∏ –±–æ–ª–µ–µ –ª—ë–≥–∫–∏—Ö –∏–∑–æ–ª–∏—Ä—É—é—â–∏—Ö –¥–≤–∏–∂–µ–Ω–∏–π.\n"
    "‚Ä¢ –ü–æ—Å–ª–µ –≤—Å–µ—Ö –¥–Ω–µ–π –¥–æ–±–∞–≤—å —Ä–∞–∑–¥–µ–ª **–ó–∞–º–µ—Ç–∫–∏ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏**, –≥–¥–µ –æ–±—ä—è—Å–Ω–∏:\n"
    "  - –∫–∞–∫ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –≤–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´+2‚Äì2.5 –∫–≥, –µ—Å–ª–∏ –≤—Å–µ –ø–æ–¥—Ö–æ–¥—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –ª–µ–≥–∫–æ¬ª);\n"
    "  - –∫–∞–∫ —É–º–µ–Ω—å—à–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ —É—Å—Ç–∞–ª–æ—Å—Ç–∏ –∏–ª–∏ –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç–µ;\n"
    "  - –æ–±—â–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (—Ç–µ—Ö–Ω–∏–∫–∞ –≤–∞–∂–Ω–µ–µ –≤–µ—Å–∞).\n\n"

    "–ü–æ–¥–±–æ—Ä —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:\n"
    "‚Ä¢ –ü—Ä–∏ 2‚Äì3 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö –≤ –Ω–µ–¥–µ–ª—é ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π full body –∏–ª–∏ upper/lower.\n"
    "‚Ä¢ –ü—Ä–∏ 4 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö ‚Äî –ø—Ä–∏–º–µ–Ω—è–π upper/lower split –∏–ª–∏ push/pull/legs.\n"
    "‚Ä¢ –ü—Ä–∏ 5+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö ‚Äî –¥–µ–ª–∞–π —Å–ø–ª–∏—Ç –ø–æ –º—ã—à–µ—á–Ω—ã–º –≥—Ä—É–ø–ø–∞–º (–≥—Ä—É–¥—å/—Å–ø–∏–Ω–∞/–Ω–æ–≥–∏/–ø–ª–µ—á–∏/—Ä—É–∫–∏ –∏ —Ç.–ø.).\n"
    "‚Ä¢ –í–∫–ª—é—á–∞–π –±–∞–∑–æ–≤—ã–µ –º–Ω–æ–≥–æ—Å—É—Å—Ç–∞–≤–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è (–ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è, –∂–∏–º—ã, —Ç—è–≥–∏, –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è/—Ç—è–≥–∏ –±–ª–æ–∫–∞) –∏ –¥–æ–ø–æ–ª–Ω—è–π –∏–∑–æ–ª–∏—Ä—É—é—â–∏–º–∏.\n"
    "‚Ä¢ –ê–¥–∞–ø—Ç–∏—Ä—É–π —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏—Å–∫–ª—é—á–∞–π –æ–ø–∞—Å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã.\n\n"

    "–ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å:\n"
    "–°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é, –±–µ–∑–æ–ø–∞—Å–Ω—É—é, —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—É—é –∏ –ø–æ–Ω—è—Ç–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É —Å–∏–ª–æ–≤—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫, "
    "–∫–æ—Ç–æ—Ä—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤ —Ç—Ä–µ–Ω–∞–∂—ë—Ä–Ω–æ–º –∑–∞–ª–µ, –≤–∫–ª—é—á–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–µ—Å–∞–º –∏ —á—ë—Ç–∫–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏."
)


QA_SYSTEM_PROMPT = (
    "–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä –≤—ã—Å–æ–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è (–æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –±–æ–ª–µ–µ 8 –ª–µ—Ç). "
    "–¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—à—å—Å—è –Ω–∞ —Å–∏–ª–æ–≤—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö, –±–æ–¥–∏–±–∏–ª–¥–∏–Ω–≥–µ, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º —Ç—Ä–µ–Ω–∏–Ω–≥–µ, –∫–∞—Ä–¥–∏–æ–Ω–∞–≥—Ä—É–∑–∫–∞—Ö, "
    "–ø–æ—Ö—É–¥–µ–Ω–∏–∏, –Ω–∞–±–æ—Ä–µ –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã, –∞ —Ç–∞–∫–∂–µ –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥–∏–∏ –∏ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–º –ø–∏—Ç–∞–Ω–∏–∏. "
    "–¢—ã —É–º–µ–µ—à—å –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ (–Ω–æ–≤–∏—á–æ–∫, —Å—Ä–µ–¥–Ω–∏–π, –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π), "
    "—É—á–∏—Ç—ã–≤–∞—è –ø–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç, –≤–µ—Å, —Ü–µ–ª—å, —á–∞—Å—Ç–æ—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"

    "–ö–∞–∫ –æ—Ç–≤–µ—á–∞—Ç—å:\n"
    "‚Ä¢ –û—Ç–≤–µ—á–∞–π **–ø–æ –¥–µ–ª—É –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ**, –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã.\n"
    "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π **Markdown** –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ –∏ –∞–∫—Ü–µ–Ω—Ç–æ–≤.\n"
    "‚Ä¢ –î–µ—Ä–∂–∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω, **–±–µ–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∏ –ø—Ä–æ—â–∞–Ω–∏–π**.\n"
    "‚Ä¢ –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –ø–æ—è—Å–Ω–µ–Ω–∏–π –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏–ª–∏ –ø–∏—Ç–∞–Ω–∏—é ‚Äî –¥–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã.\n"
    "‚Ä¢ –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç **—Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫** ‚Äî –¥–µ–ª–∞–π —ç—Ç–æ —Å—Ä–∞–∑—É, "
    "–∏—Å–ø–æ–ª—å–∑—É—è –≤—Å–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (–ø–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç, –≤–µ—Å, —É—Ä–æ–≤–µ–Ω—å, —Ü–µ–ª—å, —á–∞—Å—Ç–æ—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è).\n"
    "‚Ä¢ –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ–±—â–∏–π (–ø—Ä–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –Ω–∞–≥—Ä—É–∑–∫—É, –ø–∏—Ç–∞–Ω–∏–µ, –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—é, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ) ‚Äî –æ—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ.\n"
    "‚Ä¢ –î–∞–≤–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—ã–±–æ—Ä—É –≤–µ—Å–æ–≤ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏ –Ω–∞–≥—Ä—É–∑–∫–∏, –µ—Å–ª–∏ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ.\n"
    "‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π RPE/RIR –∏ —Å–ª–æ–≤–∞ ¬´–¥–æ –æ—Ç–∫–∞–∑–∞¬ª ‚Äî –æ–ø–∏—Å—ã–≤–∞–π —É—Å–∏–ª–∏—è —Å–ª–æ–≤–∞–º–∏ (¬´–ª—ë–≥–∫–æ¬ª, ¬´—É–º–µ—Ä–µ–Ω–Ω–æ¬ª, ¬´—Ç—è–∂–µ–ª–æ¬ª).\n\n"

    "–í–∞–∂–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:\n"
    "‚Ä¢ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–µ–∂–¥–µ –≤—Å–µ–≥–æ** ‚Äî –æ–±—ä—è—Å–Ω—è–π –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ç–µ—Ö–Ω–∏–∫—É –∏ –∫–∞–∫ –∏–∑–±–µ–≥–∞—Ç—å —Ç—Ä–∞–≤–º.\n"
    "‚Ä¢ –î–∞–≤–∞–π —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∞ –Ω–µ –æ–¥–Ω–æ—Ç–∏–ø–Ω—ã–µ —Å–æ–≤–µ—Ç—ã.\n"
    "‚Ä¢ –ï—Å–ª–∏ —Ä–µ—á—å –æ –ø–∏—Ç–∞–Ω–∏–∏ ‚Äî —É—á–∏—Ç—ã–≤–∞–π —Ü–µ–ª—å (–ø–æ—Ö—É–¥–µ–Ω–∏–µ, –Ω–∞–±–æ—Ä –º–∞—Å—Å—ã, –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã), "
    "—É–ø–æ–º–∏–Ω–∞–π –ë–ñ–£, –∫–∞–ª–æ—Ä–∏–∏ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –±–µ–ª–∫–æ–≤, —É–≥–ª–µ–≤–æ–¥–æ–≤ –∏ –∂–∏—Ä–æ–≤.\n"
    "‚Ä¢ –ò–∑–±–µ–≥–∞–π —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã—Ö –∏–ª–∏ —Ç—Ä–∞–≤–º–æ–æ–ø–∞—Å–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤.\n"
    "‚Ä¢ –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å ‚Äî –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Å—è –Ω–∞ –ø–æ–ª, –≤–µ—Å, —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏, —Ü–µ–ª—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.\n\n"

    "–¢—ã –º–æ–∂–µ—à—å –ø–æ–º–æ–≥–∞—Ç—å –ø–æ —Ç–µ–º–∞–º:\n"
    "‚Ä¢ —Å–∏–ª–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–±–∞–∑–æ–≤—ã–µ –∏ –∏–∑–æ–ª–∏—Ä—É—é—â–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è);\n"
    "‚Ä¢ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ –∫–∞—Ä–¥–∏–æ;\n"
    "‚Ä¢ –ø–∏—Ç–∞–Ω–∏–µ –¥–ª—è –ø–æ—Ö—É–¥–µ–Ω–∏—è, –Ω–∞–±–æ—Ä–∞ –º–∞—Å—Å—ã –∏ –∑–¥–æ—Ä–æ–≤—å—è;\n"
    "‚Ä¢ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏, –≤—ã–±–æ—Ä –≤–µ—Å–æ–≤ –∏ –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å;\n"
    "‚Ä¢ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, —Å–æ–Ω –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.\n"
    "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–ª–æ–∂–Ω—ã–π ‚Äî –æ—Ç–≤–µ—á–∞–π —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ, –Ω–æ –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã; –µ—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ–π ‚Äî –ª–∞–∫–æ–Ω–∏—á–Ω–æ.\n"
)


# ------------------------- –ö–ª–∞—Å—Å –∞–≥–µ–Ω—Ç–∞ -------------------------

class FitnessAgent:
    def __init__(self, token: str, user_id: str):
        self.token = token
        self.user_id = user_id
        self.user_data = load_user_data(user_id)
        phys = (self.user_data.get("physical_data") or {})
        self._user_name: Optional[str] = (phys.get("name") or "").strip() or None

    # ---------- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ GigaChat ----------

    def _chat_call(self, payload: Chat):
        """
        –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—ã–∑–æ–≤–∞ SDK (–≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö chat(model=...) –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è).
        –î–µ–ª–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ä–µ—Ç—Ä–∞–∏.
        """
        last_err = None
        for attempt in range(1, GIGACHAT_RETRIES + 1):
            try:
                # –ü–æ–ø—ã—Ç–∫–∞ ‚Ññ1: –±–µ–∑ –ø–µ—Ä–µ–¥–∞—á–∏ model –≤ chat(...)
                with GigaChat(
                    credentials=self.token,
                    verify_ssl_certs=False,
                    timeout=GIGACHAT_TIMEOUT,
                    model=GIGACHAT_MODEL,  # –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–µ—Ä—Å–∏–π –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞–¥–∞—Ç—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
                ) as giga:
                    try:
                        resp = giga.chat(payload)
                    except TypeError:
                        # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å: –ø–µ—Ä–µ–¥–∞—Ç—å model –≤ –º–µ—Ç–æ–¥
                        resp = getattr(giga, "chat")(payload, model=GIGACHAT_MODEL)
                return resp.choices[0].message.content
            except Exception as e:
                last_err = e
                if attempt == GIGACHAT_RETRIES:
                    raise
                time.sleep(1.5 * attempt)
        raise last_err or RuntimeError("GigaChat call failed")

    # ---------- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –Ω–∞—á–∞–ª–µ –æ—Ç–≤–µ—Ç–∞ ----------

    def _with_name_prefix(self, text: str) -> str:
        name = (self._user_name or "").strip()
        if not name:
            return text
        return f"{name}, –≤–æ—Ç —á—Ç–æ —è –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª ‚¨áÔ∏è\n\n{text}"

    # ---------- –û—Ç–≤–µ—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å / –∫–æ—Ä–æ—Ç–∫–∏–µ –ø–ª–∞–Ω—ã ----------

    async def get_answer(self, question: str) -> str:
        """
        ¬´–ñ–∏–≤–æ–π¬ª –æ—Ç–≤–µ—Ç. –í–°–ï–ì–î–ê —É—á–∏—Ç—ã–≤–∞–µ—Ç –∞–Ω–∫–µ—Ç—É.
        –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç –ø–ª–∞–Ω/–ø—Ä–æ–≥—Ä–∞–º–º—É ‚Äî –∞–≥–µ–Ω—Ç –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Å–∂–∞—Ç—ã–π –ø–ª–∞–Ω (—Å –≤–µ—Å–∞–º–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π).
        """
        from asyncio import to_thread

        physical = _physical_context(self.user_data)

        payload = Chat(
            messages=[
                Messages(role=MessagesRole.SYSTEM, content=QA_SYSTEM_PROMPT),
                Messages(role=MessagesRole.USER, content=f"{physical}\n\n–í–æ–ø—Ä–æ—Å/–∑–∞–ø—Ä–æ—Å:\n{question}"),
            ],
            temperature=min(0.45, GIGACHAT_TEMPERATURE),
            max_tokens=min(1200, GIGACHAT_MAX_TOKENS),
            model=GIGACHAT_MODEL,
        )

        def _call():
            return self._chat_call(payload)

        raw = await to_thread(_call)
        txt = _sanitize(raw)
        # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏
        hist = self.user_data.get("history", [])
        hist.append(("üßç " + question, "ü§ñ " + txt))
        self.user_data["history"] = hist
        save_user_data(self.user_id, self.user_data)
        return txt

    # ---------- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã ----------

    async def get_response(self, user_input: str = "") -> str:
        """
        –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å–∏–ª–æ–≤—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∫–µ—Ç—ã.
        `user_input` –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–Ω—É–∂–µ–Ω 5-–¥–Ω–µ–≤–Ω—ã–π —Å–ø–ª–∏—Ç¬ª).
        """
        from asyncio import to_thread

        physical = _physical_context(self.user_data)

        messages = [
            Messages(role=MessagesRole.SYSTEM, content=PLAN_SYSTEM_PROMPT),
            Messages(role=MessagesRole.USER, content=physical),
        ]
        if user_input and user_input.strip():
            messages.append(Messages(role=MessagesRole.USER, content=f"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è: {user_input}"))

        payload = Chat(
            messages=messages,
            temperature=GIGACHAT_TEMPERATURE,
            max_tokens=GIGACHAT_MAX_TOKENS,
            model=GIGACHAT_MODEL,
        )

        def _call():
            return self._chat_call(payload)

        raw = await to_thread(_call)
        cleaned = _sanitize(raw)
        personalized = self._with_name_prefix(cleaned)

        # –ò—Å—Ç–æ—Ä–∏—è
        hist = self.user_data.get("history", [])
        hist.append(("üßç –ó–∞–ø—Ä–æ—Å –ø—Ä–æ–≥—Ä–∞–º–º—ã" if not user_input else "üßç " + user_input, "ü§ñ " + personalized))
        self.user_data["history"] = hist
        # –ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç ‚Äî –¥–ª—è ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª¬ª
        self.user_data["last_reply"] = personalized
        self.user_data["last_program"] = personalized
        save_user_data(self.user_id, self.user_data)

        return personalized
