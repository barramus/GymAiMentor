# app/agent.py

from __future__ import annotations

import os
import re
import time
from typing import Optional, Dict, Tuple

from gigachat import GigaChat
from gigachat.models import Chat, Messages, MessagesRole

from app.storage import load_user_data, save_user_data
from app.weights import (
    User as WUser,
    History as WHistory,
    recommend_weight_for_exercise,  # —Ç–æ—á–µ—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç –ø–æ–¥ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
    recommend_start_weight,         # —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å, –µ—Å–ª–∏ –∫–ª—é—á –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω
    base_key,
)

# ---------------- –ö–æ–Ω—Ñ–∏–≥ –º–æ–¥–µ–ª–∏ ----------------

GIGACHAT_MODEL: str = os.getenv("GIGACHAT_MODEL", "GigaChat-2-Max").strip()
GIGACHAT_TEMPERATURE: float = float(os.getenv("GIGACHAT_TEMPERATURE", "0.2"))
GIGACHAT_MAX_TOKENS: int = int(os.getenv("GIGACHAT_MAX_TOKENS", "2000"))
GIGACHAT_TIMEOUT: int = int(os.getenv("GIGACHAT_TIMEOUT", "60"))
GIGACHAT_RETRIES: int = int(os.getenv("GIGACHAT_RETRIES", "3"))


# ---------------- –£—Ç–∏–ª–∏—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ----------------

_RPE_PATTERNS = [
    r"\(?\s*RPE\s*=?\s*\d+(?:\s*-\s*\d+)?\s*\)?",
    r"\(?\s*RIR\s*=?\s*\d+(?:\s*-\s*\d+)?\s*\)?",
    r"\b–¥–æ\s+–æ—Ç–∫–∞–∑–∞\b",
    r"\b–ø–æ—á—Ç–∏\s+–¥–æ\s+–æ—Ç–∫–∞–∑–∞\b",
]

def _strip_rpe(text: str) -> str:
    """–£–±–∏—Ä–∞–µ–º RPE/RIR/¬´–¥–æ –æ—Ç–∫–∞–∑–∞¬ª, –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –º–∞—Ä–∫–µ—Ä—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã, –Ω–µ –ª–æ–º–∞—è Markdown."""
    out = text or ""
    for p in _RPE_PATTERNS:
        out = re.sub(p, "", out, flags=re.IGNORECASE)

    # HTML ‚Üí –ø–µ—Ä–µ–Ω–æ—Å—ã
    out = re.sub(r"\s*<br\s*/?>\s*", "\n", out, flags=re.IGNORECASE)
    out = re.sub(r"</?p\s*/?>", "\n", out, flags=re.IGNORECASE)

    # bullets ‚Üí –¥–µ—Ñ–∏—Å—ã
    out = re.sub(r"^\s*‚Ä¢\s+", "- ", out, flags=re.MULTILINE)

    # 3x12 -> 3√ó12
    out = re.sub(r"(\d)\s*[xX\*]\s*(\d)", r"\1√ó\2", out)

    # —á–∏—Å—Ç–∏–º –ø—É—Å—Ç—ã–µ —Å–∫–æ–±–∫–∏ –∏ –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
    out = re.sub(r"\(\s*\)", "", out)
    out = re.sub(r",\s*,", ", ", out)
    out = re.sub(r"[ \t]{2,}", " ", out)
    out = re.sub(r"[ \t]+\n", "\n", out)
    out = re.sub(r"\n[ \t]+", "\n", out)
    out = re.sub(r"\n{3,}", "\n\n", out)

    # –≤–∏—Å—è—á–∏–µ –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –±—ç–∫—Ç–∏–∫–∏
    out = re.sub(r"`(?=[^`]*$)", "", out)
    return out.strip()

def _to_int(s: str | int | None) -> Optional[int]:
    if s is None:
        return None
    if isinstance(s, int):
        return s
    m = re.search(r"\d+", str(s))
    return int(m.group(0)) if m else None


# ---------------- –ê–≥–µ–Ω—Ç ----------------

class FitnessAgent:
    def __init__(self, token: str, user_id: str):
        self.token = token
        self.user_id = user_id
        self.user_data = load_user_data(user_id)

        physical_data = self.user_data.get("physical_data", {}) or {}
        self._user_name: Optional[str] = (physical_data.get("name") or "").strip() or None

        # –ñ—ë—Å—Ç–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –æ—Ç –∞–Ω–∫–µ—Ç—ã –∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø–ª–∞–Ω–∞
        level = (physical_data.get("level") or "").strip().lower()
        days = _to_int(physical_data.get("schedule"))
        per_day = "5‚Äì7" if level == "–æ–ø—ã—Ç–Ω—ã–π" else "4‚Äì5"

        strict_bits = []
        if days:
            strict_bits.append(f"‚Ä¢ –°–¥–µ–ª–∞–π –†–û–í–ù–û {days} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –¥–Ω–µ–π –≤ –Ω–µ–¥–µ–ª—é.")
        strict_bits.append(f"‚Ä¢ –í –∫–∞–∂–¥–æ–º –¥–Ω–µ –ø–µ—Ä–µ—á–∏—Å–ª–∏ {per_day} —Å–∏–ª–æ–≤—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π (–Ω–µ —Å—á–∏—Ç–∞—è —Ä–∞–∑–º–∏–Ω–∫—É –∏ –∑–∞–º–∏–Ω–∫—É).")
        strict_bits.append("‚Ä¢ –ï—Å–ª–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –º–µ–Ω—å—à–µ ‚Äî –¥–æ–±–∞–≤—å, –µ—Å–ª–∏ –±–æ–ª—å—à–µ ‚Äî —Å–æ–∫—Ä–∞—Ç–∏.")
        strict_bits.append("‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π HTML-—Ç–µ–≥–∏ (<br>, <p>) ‚Äî —Ç–æ–ª—å–∫–æ Markdown –∏ –æ–±—ã—á–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫.")
        strict_text = "\n".join(strict_bits)

        physical_prompt = self._format_physical_data(physical_data)

        # –ë–∞–∑–æ–≤—ã–π —á–∞—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ü–õ–ê–ù–û–í
        self.payload = Chat(
            messages=[
                Messages(
                    role=MessagesRole.SYSTEM,
                    content=(
                        "–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä –ø–æ —Å–∏–ª–æ–≤—ã–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º –∏ –±–æ–¥–∏–±–∏–ª–¥–∏–Ω–≥—É (–æ–ø—ã—Ç –±–æ–ª–µ–µ 8 –ª–µ—Ç). "
                        "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ, –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è –∑–∞–ª–∞ "
                        "—Å —É—á—ë—Ç–æ–º —Ü–µ–ª–µ–π, –ø–æ–ª–∞, –≤–æ–∑—Ä–∞—Å—Ç–∞, –≤–µ—Å–∞, —É—Ä–æ–≤–Ω—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏, —á–∞—Å—Ç–æ—Ç—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"

                        "### –û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞:\n"
                        "‚Ä¢ –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ **Markdown**.\n"
                        "‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π, –ª–∏—à–Ω–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ç–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤—ã–π –ø–ª–∞–Ω.\n"
                        "‚Ä¢ –ü–∏—à–∏ –≥—Ä–∞–º–æ—Ç–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ, –∫–∞–∫ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Ñ–∏—Ç–Ω–µ—Å-–∫–ª—É–±–µ.\n"
                        "‚Ä¢ –°—Ç—Ä–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—É **–±–µ–∑ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª–Ω–æ—Å—Ç—å—é.\n"
                        "‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π RPE/RIR –∏ —Å–ª–æ–≤–∞ ¬´–¥–æ –æ—Ç–∫–∞–∑–∞¬ª.\n"
                        "‚Ä¢ –î–∞–≤–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–µ—Å–∞–º –æ—Ç—è–≥–æ—â–µ–Ω–∏–π, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "
                        "(–ø–æ–ª, –≤–µ—Å, –≤–æ–∑—Ä–∞—Å—Ç, —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏, —Ü–µ–ª—å, –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è).\n"
                        "‚Ä¢ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ–¥–±–∏—Ä–∞–π —Ç–∞–∫, —á—Ç–æ–±—ã –ø—Ä–æ–≥—Ä–∞–º–º–∞ –±—ã–ª–∞ **–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–π, —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π**, "
                        "–Ω–æ –ø—Ä–∏ —ç—Ç–æ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ —É—Ä–æ–≤–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n"
                        "‚Ä¢ –ò–∑–±–µ–≥–∞–π —Å–ª–æ–∂–Ω—ã—Ö, —Ç—Ä–∞–≤–º–æ–æ–ø–∞—Å–Ω—ã—Ö –∏–ª–∏ –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –¥–≤–∏–∂–µ–Ω–∏–π, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤–∏—á–æ–∫ "
                        "(–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ –≤–∫–ª—é—á–∞–π –æ–ª–∏–º–ø–∏–π—Å–∫–∏–µ –ø–æ–¥—ä—ë–º—ã –±–µ–∑ –æ–ø—ã—Ç–∞).\n"
                        "‚Ä¢ –ü–æ–¥–±–∏—Ä–∞–π —Ä–∞–∑—É–º–Ω—ã–π –æ–±—ä—ë–º —Ä–∞–±–æ—Ç—ã: –Ω–µ —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ –∏ –Ω–µ —á—Ä–µ–∑–º–µ—Ä–Ω–æ, —á—Ç–æ–±—ã —Ö–≤–∞—Ç–∞–ª–æ —Ä–µ—Å—É—Ä—Å–∞ –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å.\n\n"

                        "### –§–æ—Ä–º–∞—Ç –ø–ª–∞–Ω–∞:\n"
                        "‚Ä¢ –ö–∞–∂–¥—ã–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –¥–µ–Ω—å –ø–∏—à–∏ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ –æ—Ç–¥–µ–ª—è–π –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π.\n"
                        "‚Ä¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–Ω—è: **–î–µ–Ω—å N ‚Äî —á–∞—Å—Ç—å —Ç–µ–ª–∞/—Ç–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä: **–î–µ–Ω—å 1 ‚Äî –ì—Ä—É–¥—å –∏ —Ç—Ä–∏—Ü–µ–ø—Å**).\n"
                        "‚Ä¢ –í –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è —É–∫–∞–∂–∏ —Ä–∞–∑–º–∏–Ω–∫—É (5‚Äì7 –º–∏–Ω—É—Ç) —Å –ø—Ä–æ—Å—Ç—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏ (–∫–∞—Ä–¥–∏–æ, —Å—É—Å—Ç–∞–≤–Ω–∞—è —Ä–∞–∑–º–∏–Ω–∫–∞).\n"
                        "‚Ä¢ –í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –¥–æ–±–∞–≤—å –∑–∞–º–∏–Ω–∫—É/—Ä–∞—Å—Ç—è–∂–∫—É (3‚Äì5 –º–∏–Ω—É—Ç).\n"
                        "‚Ä¢ –ö–∞–∂–¥–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –æ—Ñ–æ—Ä–º–ª—è–π —Ç–∞–∫: ¬´- –ù–∞–∑–≤–∞–Ω–∏–µ ‚Äî 3√ó12, –æ—Ç–¥—ã—Ö 90 —Å–µ–∫., —É—Å–∏–ª–∏–µ: —É–º–µ—Ä–µ–Ω–Ω–æ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –≤–µ—Å: ~40 –∫–≥¬ª.\n"
                        "‚Ä¢ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–π **—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –≤–µ—Å** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è "
                        "(–æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Å—è –Ω–∞ –ø–æ–ª, –≤–µ—Å, —É—Ä–æ–≤–µ–Ω—å, —Ü–µ–ª—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É –¥–ª—è –ø–µ—Ä–≤—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤). "
                        "–ï—Å–ª–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º –≤–µ—Å–æ–º ‚Äî —Ç–∞–∫ –∏ —É–∫–∞–∑—ã–≤–∞–π (¬´—Ä–∞–±–æ—Ç–∞ —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º –≤–µ—Å–æ–º¬ª).\n"
                        "‚Ä¢ –ï—Å–ª–∏ –≤–µ—Å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π, —É—Ç–æ—á–Ω–∏ —ç—Ç–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´~40 –∫–≥ –ø—Ä–∏ 8‚Äì10 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è—Ö¬ª).\n"
                        "‚Ä¢ –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è —É–∫–∞–∑—ã–≤–∞–π **–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Ö–æ–¥–æ–≤ –∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π**, –∞ —Ç–∞–∫–∂–µ –≤—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞ "
                        "–¥–ª—è –≤—Å–µ—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π (—Ä–∞–∑–ª–∏—á–∞–π —Ç—è–∂—ë–ª—ã–µ –±–∞–∑–æ–≤—ã–µ –∏ –∏–∑–æ–ª–∏—Ä—É—é—â–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è).\n"
                        "‚Ä¢ –í –∫–æ–Ω—Ü–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π —Ä–∞–∑–¥–µ–ª **–ó–∞–º–µ—Ç–∫–∏ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏**, –≥–¥–µ –æ–±—ä—è—Å–Ω—è–µ—à—å:\n"
                        "  - –∫–∞–∫ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –≤–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´+2‚Äì2.5 –∫–≥, –µ—Å–ª–∏ –≤—Å–µ –ø–æ–¥—Ö–æ–¥—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –ª–µ–≥–∫–æ¬ª);\n"
                        "  - –∫–∞–∫ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ —É—Ç–æ–º–ª–µ–Ω–∏–∏ –∏–ª–∏ –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç–µ;\n"
                        "  - –æ–±—â–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Ç–µ—Ö–Ω–∏–∫–∞ –≤–∞–∂–Ω–µ–µ –≤–µ—Å–∞).\n\n"

                        "### –ü–æ–¥–±–æ—Ä —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:\n"
                        "‚Ä¢ –ü—Ä–∏ 2‚Äì3 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö –≤ –Ω–µ–¥–µ–ª—é ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π **full body** –∏–ª–∏ upper/lower.\n"
                        "‚Ä¢ –ü—Ä–∏ 4 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π **upper/lower split** –∏–ª–∏ push/pull/legs.\n"
                        "‚Ä¢ –ü—Ä–∏ 5+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö ‚Äî –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–ª–∏—Ç –ø–æ –º—ã—à–µ—á–Ω—ã–º –≥—Ä—É–ø–ø–∞–º.\n"
                        "‚Ä¢ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–π –±–∞–∑–æ–≤—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è (–ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è, –∂–∏–º, —Ç—è–≥–∞, –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è/—Ç—è–≥–∏) –∏ –¥–æ–ø–æ–ª–Ω—è–π –∏–∑–æ–ª–∏—Ä—É—é—â–∏–º–∏.\n"
                        "‚Ä¢ –ï—Å–ª–∏ –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏–ª–∏ —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞ ‚Äî –∞–¥–∞–ø—Ç–∏—Ä—É–π —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"

                        "### –ö–ª—é—á–µ–≤–∞—è –∑–∞–¥–∞—á–∞:\n"
                        "–°–æ–∑–¥–∞—Ç—å **—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é, –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∏ –ø–æ–Ω—è—Ç–Ω—É—é** –ø—Ä–æ–≥—Ä–∞–º–º—É, –∫–æ—Ç–æ—Ä—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç "
                        "–≤—ã–ø–æ–ª–Ω—è—Ç—å –≤ –∑–∞–ª–µ, –≤–∫–ª—é—á–∞—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä –ø–æ –≤–µ—Å–∞–º –∏ —Å–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏.\n"
                        f"{strict_text}\n"
                    ),
                ),
                Messages(role=MessagesRole.USER, content=physical_prompt),
            ],
            temperature=GIGACHAT_TEMPERATURE,
            max_tokens=GIGACHAT_MAX_TOKENS,
            model=GIGACHAT_MODEL,
        )

    # ---------- –ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã ----------

    async def get_answer(self, question: str) -> str:
        """
        –ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç (–∂–∏–≤–æ–π –¥–∏–∞–ª–æ–≥), –ù–û —Å —É—á—ë—Ç–æ–º –∞–Ω–∫–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç ¬´—Å–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω¬ª, –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –º–æ–∂–µ—Ç —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å.
        """
        from asyncio import to_thread

        # –≤–∫–ª–µ–∏–º —Ñ–∏–∑–∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –≤–æ–ø—Ä–æ—Å
        context = self._format_physical_data(self.user_data.get("physical_data") or {})
        qa_payload = Chat(
            messages=[
                Messages(
                    role=MessagesRole.SYSTEM,
                    content=(
                        "–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä –≤—ã—Å–æ–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è (–æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –±–æ–ª–µ–µ 8 –ª–µ—Ç). "
                        "–¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—à—å—Å—è –Ω–∞ —Å–∏–ª–æ–≤—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö, –±–æ–¥–∏–±–∏–ª–¥–∏–Ω–≥–µ, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º —Ç—Ä–µ–Ω–∏–Ω–≥–µ, "
                        "–∫–∞—Ä–¥–∏–æ–Ω–∞–≥—Ä—É–∑–∫–∞—Ö, –ø–æ—Ö—É–¥–µ–Ω–∏–∏, –Ω–∞–±–æ—Ä–µ –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã, –∞ —Ç–∞–∫–∂–µ –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥–∏–∏ –∏ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–º –ø–∏—Ç–∞–Ω–∏–∏. "
                        "–¢—ã —É–º–µ–µ—à—å –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ (–Ω–æ–≤–∏—á–æ–∫, —Å—Ä–µ–¥–Ω–∏–π, –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π), "
                        "—É—á–∏—Ç—ã–≤–∞—è –ø–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç, –≤–µ—Å, —Ü–µ–ª–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"

                        "### –ö–∞–∫ –æ—Ç–≤–µ—á–∞—Ç—å:\n"
                        "‚Ä¢ –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π **–ø–æ –¥–µ–ª—É, –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã**, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ.\n"
                        "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π **Markdown** –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤ –∏ –∞–∫—Ü–µ–Ω—Ç–æ–≤.\n"
                        "‚Ä¢ –û—Ç–≤–µ—á–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –Ω–æ –±–µ–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∏ –ø—Ä–æ—â–∞–Ω–∏–π.\n"
                        "‚Ä¢ –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –ø–æ—è—Å–Ω–µ–Ω–∏–π –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏–ª–∏ –ø–∏—Ç–∞–Ω–∏—é ‚Äî –¥–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã.\n"
                        "‚Ä¢ –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç **—Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω/–ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫**, –º–æ–∂–µ—à—å —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ —Å—Ä–∞–∑—É "
                        "(–∏—Å–ø–æ–ª—å–∑—É—è –≤—Å–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –æ –Ω—ë–º —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ: –ø–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç, –≤–µ—Å, —Ü–µ–ª—å, —É—Ä–æ–≤–µ–Ω—å, —á–∞—Å—Ç–æ—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è).\n"
                        "‚Ä¢ –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ–±—â–∏–π (–ø—Ä–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –Ω–∞–≥—Ä—É–∑–∫—É, –ø–∏—Ç–∞–Ω–∏–µ, –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—é, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ) ‚Äî –æ—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, "
                        "—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ, —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏.\n"
                        "‚Ä¢ –î–∞–≤–∞–π —Å–æ–≤–µ—Ç—ã –ø–æ –≤—ã–±–æ—Ä—É –≤–µ—Å–∞ –æ—Ç—è–≥–æ—â–µ–Ω–∏–π –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏ –Ω–∞–≥—Ä—É–∑–∫–∏, –µ—Å–ª–∏ —ç—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ.\n"
                        "‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π RPE/RIR –∏ —Å–ª–æ–≤–∞ ¬´–¥–æ –æ—Ç–∫–∞–∑–∞¬ª ‚Äî –æ–ø–∏—Å—ã–≤–∞–π —É—Å–∏–ª–∏—è —Å–ª–æ–≤–∞–º–∏ (¬´–ª—ë–≥–∫–æ¬ª, ¬´—É–º–µ—Ä–µ–Ω–Ω–æ¬ª, ¬´—Ç—è–∂–µ–ª–æ¬ª).\n\n"

                        "### –í–∞–∂–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:\n"
                        "‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–µ–∂–¥–µ –≤—Å–µ–≥–æ ‚Äî –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ç–µ—Ö–Ω–∏–∫—É –∏ –∫–∞–∫ –∏–∑–±–µ–≥–∞—Ç—å —Ç—Ä–∞–≤–º.\n"
                        "‚Ä¢ –î–∞–≤–∞–π —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∞ –Ω–µ –æ–¥–Ω–æ—Ç–∏–ø–Ω—ã–µ —Å–æ–≤–µ—Ç—ã.\n"
                        "‚Ä¢ –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –ø–∏—Ç–∞–Ω–∏–µ ‚Äî —É—á–∏—Ç—ã–≤–∞–π —Ü–µ–ª—å (–ø–æ—Ö—É–¥–µ–Ω–∏–µ, –Ω–∞–±–æ—Ä –º–∞—Å—Å—ã, –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã), "
                        "—É–ø–æ–º–∏–Ω–∞–π –ë–ñ–£, –∫–∞–ª–æ—Ä–∏–∏, –ø–æ–ª–µ–∑–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –±–µ–ª–∫–∞/—É–≥–ª–µ–≤–æ–¥–æ–≤/–∂–∏—Ä–æ–≤.\n"
                        "‚Ä¢ –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ–æ–ø—ã—Ç–µ–Ω, –∏–∑–±–µ–≥–∞–π —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã—Ö –∏–ª–∏ —Ç—Ä–∞–≤–º–æ–æ–ø–∞—Å–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.\n"
                        "‚Ä¢ –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∏–º–µ—Ä–Ω—ã–µ –≤–µ—Å–∞ ‚Äî –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Å—è –Ω–∞ –ø–æ–ª, –≤–µ—Å, —É—Ä–æ–≤–µ–Ω—å –∏ —Ü–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"

                        "–¢—ã –º–æ–∂–µ—à—å –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å:\n"
                        "‚Ä¢ —Å–∏–ª–æ–≤—ã–º–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏ (–±–∞–∑–æ–≤—ã–µ –∏ –∏–∑–æ–ª–∏—Ä—É—é—â–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è);\n"
                        "‚Ä¢ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏ –∏ –∫–∞—Ä–¥–∏–æ;\n"
                        "‚Ä¢ –ø–∏—Ç–∞–Ω–∏–µ–º –¥–ª—è –ø–æ—Ö—É–¥–µ–Ω–∏—è, –Ω–∞–±–æ—Ä–∞ –º–∞—Å—Å—ã –∏ –∑–¥–æ—Ä–æ–≤—å—è;\n"
                        "‚Ä¢ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –∏ –≤—ã–±–æ—Ä–æ–º –≤–µ—Å–æ–≤;\n"
                        "‚Ä¢ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º, —Å–Ω–æ–º –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.\n"
                    ),
                ),
                Messages(
                    role=MessagesRole.USER,
                    content=(
                        "–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n"
                        f"{context}\n\n"
                        "–í–æ–ø—Ä–æ—Å:\n"
                        f"{question}"
                    ),
                ),
            ],
            temperature=min(0.45, GIGACHAT_TEMPERATURE),
            max_tokens=900,
            model=GIGACHAT_MODEL,
        )

        def _chat_sync():
            last_err = None
            for attempt in range(1, GIGACHAT_RETRIES + 1):
                try:
                    # –ù–æ–≤—ã–π SDK: –º–æ–¥–µ–ª—å –≤ Chat(); —Å—Ç–∞—Ä—ã–π ‚Äî –∏–Ω–æ–≥–¥–∞ —Ä—É–≥–∞–ª—Å—è –Ω–∞ –∞—Ä–≥—É–º–µ–Ω—Ç model
                    try:
                        with GigaChat(credentials=self.token, verify_ssl_certs=False, timeout=GIGACHAT_TIMEOUT) as giga:
                            resp = giga.chat(qa_payload)
                            return resp.choices[0].message.content
                    except TypeError:
                        with GigaChat(credentials=self.token, verify_ssl_certs=False, timeout=GIGACHAT_TIMEOUT, model=GIGACHAT_MODEL) as giga:
                            resp = giga.chat(qa_payload)
                            return resp.choices[0].message.content
                except Exception as e:
                    last_err = e
                    if attempt == GIGACHAT_RETRIES:
                        raise
                    time.sleep(2 * attempt)
            raise last_err or RuntimeError("GigaChat call failed (Q&A)")

        txt = await to_thread(_chat_sync)
        txt = _strip_rpe(txt)
        return txt.strip()

    async def get_response(self, user_input: str) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ –∞–Ω–∫–µ—Ç–µ, —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –≤–µ—Å–∞–º –æ—Ç—è–≥–æ—â–µ–Ω–∏—è.
        """
        from asyncio import to_thread

        if user_input and user_input.strip():
            self.payload.messages.append(Messages(role=MessagesRole.USER, content=user_input))

        def _chat_sync():
            last_err = None
            for attempt in range(1, GIGACHAT_RETRIES + 1):
                try:
                    try:
                        with GigaChat(credentials=self.token, verify_ssl_certs=False, timeout=GIGACHAT_TIMEOUT) as giga:
                            response = giga.chat(self.payload)
                            return response.choices[0].message
                    except TypeError:
                        with GigaChat(credentials=self.token, verify_ssl_certs=False, timeout=GIGACHAT_TIMEOUT, model=GIGACHAT_MODEL) as giga:
                            response = giga.chat(self.payload)
                            return response.choices[0].message
                except Exception as e:
                    if attempt == GIGACHAT_RETRIES:
                        raise
                    time.sleep(2 * attempt)
            raise RuntimeError("GigaChat call failed (plan)")

        message = await to_thread(_chat_sync)
        self.payload.messages.append(message)

        cleaned = _strip_rpe(message.content)
        personalized = self._with_name_prefix(cleaned)

        # –¥–æ–±–∞–≤–∏–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–µ—Å–∞–º
        try:
            personalized = self._annotate_plan_with_weights(personalized)
        except Exception:
            # –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–¥–∞—á—É, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
            pass

        # —Å–æ—Ö—Ä–∞–Ω–∏–º –≤ –∏—Å—Ç–æ—Ä–∏—é (–¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã ¬´–∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞¬ª, –µ—Å–ª–∏ –Ω–∞–¥–æ)
        history = self.user_data.get("history", [])
        if user_input and user_input.strip():
            history.append(("üßç " + user_input, "ü§ñ " + personalized))
        else:
            history.append(("üßç –ó–∞–ø—Ä–æ—Å –ø—Ä–æ–≥—Ä–∞–º–º—ã", "ü§ñ " + personalized))
        self.user_data["history"] = history
        # –∑–∞–ø–æ–º–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é –ø—Ä–æ–≥—Ä–∞–º–º—É –¥–ª—è ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª¬ª
        self.user_data["last_program"] = personalized
        save_user_data(self.user_id, self.user_data)

        return personalized

    # ---------- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ ----------

    def _format_physical_data(self, data: dict) -> str:
        return (
            f"–¶–µ–ª—å: {data.get('target', '–Ω–µ —É–∫–∞–∑–∞–Ω–∞')}\n"
            f"–ü–æ–ª: {data.get('gender', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            f"–í–æ–∑—Ä–∞—Å—Ç: {data.get('age', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')} –ª–µ—Ç\n"
            f"–†–æ—Å—Ç: {data.get('height', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')} —Å–º\n"
            f"–¢–µ–∫—É—â–∏–π –≤–µ—Å: {data.get('weight', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')} –∫–≥\n"
            f"–ñ–µ–ª–∞–µ–º—ã–π –≤–µ—Å: {data.get('goal', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')} –∫–≥\n"
            f"–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: {data.get('restrictions', '–Ω–µ—Ç')}\n"
            f"–ß–∞—Å—Ç–æ—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: {data.get('schedule', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            f"–£—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏: {data.get('level', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}"
        )

    def _with_name_prefix(self, text: str) -> str:
        name = (self._user_name or "").strip()
        prefix = f"{name}, –æ–±—Ä–∞–±–æ—Ç–∞–ª —Ç–≤–æ–π –∑–∞–ø—Ä–æ—Å ‚Äî –≤–æ—Ç —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å ‚¨áÔ∏è\n\n" if name else ""
        return prefix + (text or "")

    def _weight_context(self) -> Tuple[WUser, Dict[str, WHistory]]:
        """
        –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –≤–µ—Å–æ–≤: –∞–Ω–∫–µ—Ç–∞ -> WUser, –∏—Å—Ç–æ—Ä–∏—è -> WHistory.
        """
        d = self.user_data or {}
        phys = (d.get("physical_data") or {})
        # –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –ø—Ä–∏–≤–æ–¥–∏–º –≤–µ—Å –∏–∑ —Å—Ç—Ä–æ–∫–∏
        weight_val = phys.get("weight")
        try:
            weight_kg = float(str(weight_val).replace(",", ".")) if weight_val is not None else None
        except Exception:
            weight_kg = None

        user = WUser(
            gender=(phys.get("gender") or "").lower() or None,
            age=_to_int(phys.get("age")),
            height_cm=_to_int(phys.get("height")),
            weight_kg=weight_kg,
            level=(phys.get("level") or "").lower() or None,
            target=(phys.get("target") or "").lower() or None,
        )

        # –ò—Å—Ç–æ—Ä–∏—è –ø–æ –∫–ª—é—á–∞–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
        hist_raw = d.get("lifts") or {}
        history: Dict[str, WHistory] = {}
        for k, rec in hist_raw.items():
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–º–µ—Ä (–∏/–∏–ª–∏ –º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
            last_weight = rec.get("last_weight")
            reps = rec.get("reps")
            history[k] = WHistory(last_weight=last_weight, reps=reps, rir=None)
        return user, history

    def _annotate_plan_with_weights(self, text: str) -> str:
        """
        –ù–∞—Ö–æ–¥–∏—Ç —Å—Ç—Ä–æ–∫–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç–∞:
          - –ù–∞–∑–≤–∞–Ω–∏–µ ‚Äî 3√ó12, –æ—Ç–¥—ã—Ö 90 —Å–µ–∫.
        –ò –¥–æ–±–∞–≤–ª—è–µ—Ç —Ö–≤–æ—Å—Ç: ', —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ~–• –∫–≥'
        """
        user, history = self._weight_context()

        def _norm(s: str) -> str:
            s = (s or "").lower().replace("—ë", "–µ")
            return re.sub(r"\s+", " ", s).strip()

        lines = (text or "").splitlines()
        out = []
        for ln in lines:
            m = re.search(r"^\s*-\s*(.+?)\s+‚Äî\s+(\d+\s*√ó\s*\d+(?:‚Äì\d+)?)", ln)
            if not m:
                out.append(ln)
                continue

            raw_name = m.group(1)
            key = base_key(_norm(raw_name)) or ""
            try:
                # –µ—Å–ª–∏ –∑–Ω–∞–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ‚Äî —Ç–æ—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Å —É—á—ë—Ç–æ–º —Ç–∏–ø–∞ —Å–Ω–∞—Ä—è–¥–∞
                if key:
                    rec = history.get(key)
                    w, _src = recommend_weight_for_exercise(raw_name, user, target_reps=10, history=rec)
                    val = int(w) if float(w).is_integer() else round(float(w), 1)
                else:
                    # –æ–±—â–∏–π fallback
                    w = recommend_start_weight(user, None, key=None, target_reps=10, exercise_name=raw_name)
                    val = int(w) if float(w).is_integer() else round(float(w), 1)
            except Exception:
                out.append(ln)
                continue

            if "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü" not in ln:
                ln = f"{ln}, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ~{val} –∫–≥"

            out.append(ln)

        return "\n".join(out)
